"use strict";function t(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var e=t(require("event-emitter-object")),i=t(require("visibility-state-listener")),s=require("basekits"),n={default:180,ar:138,ch:158,nl:202,en:228,fi:161,fr:195,de:179,iw:187,it:188,jp:193,pl:166,pt:181,ru:184,sl:180,sp:218,sv:199,tr:166};function o(){e.call(this,{}),this.isWindowVisible=!0,this.visibilityStateListener=i(),this.visibilityStateListener.start(),this.visibilityStateListener.emitter.on("update",function(){this.isWindowVisible="visible"==this.visibilityStateListener.getState()}.bind(this))}o.prototype=Object.create(e.prototype),o.prototype.constructor=o,o.prototype.clearMemory=function(t){this.element=t,this.progress=0,this.reading=!1,this.readingTime=0,this.targetReadingTime=0,this.milestones=[],this.absMilestones=[],this.distance=this.getElementDistanceFromTop(this.element),this.hasScroll=null,this.viewport=s.domkit.getViewportDimensions(),this.lastTimestamp=0,this.timeInterval=null},o.prototype.start=function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"default";if(s.typekit.isDOMElement(t)){this.clearMemory(t);var o=s.objectkit.getProp(n,i,"default"),r=this.element.innerText.split(" ").filter((function(t){return t.length>1}));this.targetReadingTime=Math.floor(r.length/o*60);var h=this.element.scrollHeight,l=this.element.clientHeight;this.hasScroll=h!==l;for(var a=this.viewport.height<l?this.viewport.height:l,c=this.hasScroll?0:this.distance,m=1;m<=Math.floor(h/a);m++)this.milestones.push(c+a*m);return(this.hasScroll||l>this.viewport.height)&&this.milestones.push(c+h),this.absMilestones=[].concat(this.milestones),this.onScroll(),this.hasScroll?this.element.onscroll=s.functionkit.debounce(this.onScroll.bind(this),300):window.onscroll=s.functionkit.debounce(this.onScroll.bind(this),300),this.timeInterval=setInterval((function(){return e.checkReadingTime()}),1e3),this}},o.prototype.onScroll=function(){if(this.checkReadingTime()&&0!==this.milestones.length){var t=document.documentElement.scrollTop||document.body.scrollTop||0,e=this.viewport.height<this.element.clientHeight?this.viewport.height:this.element.clientHeight;(this.hasScroll?this.element.scrollTop+e:t+this.viewport.height)>=this.milestones[0]&&(this.milestones.shift(),this.checkProgress())}},o.prototype.checkReadingTime=function(){var t=document.documentElement.scrollTop||document.body.scrollTop||0,e=this.distance-t,i=this.viewport.height-e>0,s=this.distance+this.element.clientHeight-t>0,n=!0===i&&!0===s&&!0===this.isWindowVisible,o=this.getTimestamp();return n?!1===this.reading?(this.lastTimestamp=o,this.reading=!0):!0===this.reading&&(this.readingTime+=o-this.lastTimestamp,this.lastTimestamp=o):!0===this.reading&&(this.readingTime+=o-this.lastTimestamp,this.reading=!1),this.checkProgress(),n},o.prototype.checkProgress=function(){var t=Number.parseFloat((this.absMilestones.length-this.milestones.length)/this.absMilestones.length*100),e=this.targetReadingTime,i=Math.ceil(this.readingTime/e*100),s=0;s=i>=t?t:t>=75&&i>=75||t>=50&&i>=50?i:0,this.progress!==s&&s>this.progress&&(this.progress=s,this.emit("progress",Math.ceil(this.progress)),100===Math.ceil(this.progress)&&(clearInterval(this.timeInterval),this.timeInterval=null,this.hasScroll?this.element.onscroll=null:window.onscroll=null))},o.prototype.getTimestamp=function(){return Math.ceil(Date.now()/1e3)},o.prototype.getElementDistanceFromTop=function(t){for(var e=t.offsetTop,i=t.parentElement;s.validationkit.isNotEmpty(i);)e+=i.offsetTop,i=i.parentElement;return e},module.exports=o;
