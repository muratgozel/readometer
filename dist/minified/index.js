const EventEmitter=require("event-emitter-object"),createVisibilityStateListener=require("visibility-state-listener"),kit=require("@basekits/core"),kitType=require("@basekits/kit-type"),kitObject=require("@basekits/kit-object"),kitError=require("@basekits/kit-error"),kitValidator=require("@basekits/kit-validator"),kitDOM=require("@basekits/kit-dom"),kitFn=require("@basekits/kit-function");kit.addKit(kitType),kit.addKit(kitObject),kit.addKit(kitError),kit.addKit(kitValidator),kit.addKit(kitDOM),kit.addKit(kitFn);const avgReadingSpeeds=require("./readingSpeedsByLanguage");function Readometer(){EventEmitter.call(this,{}),this.isWindowVisible=!0,this.visibilityStateListener=createVisibilityStateListener(),this.visibilityStateListener.start(),this.visibilityStateListener.emitter.on("update",function(){this.isWindowVisible="visible"==this.visibilityStateListener.getState()}.bind(this))}Readometer.prototype=Object.create(EventEmitter.prototype),Readometer.prototype.constructor=Readometer,Readometer.prototype.clearMemory=function(a){this.element=a,this.progress=0,this.reading=!1,this.readingTime=0,this.targetReadingTime=0,this.milestones=[],this.absMilestones=[],this.distance=this.getElementDistanceFromTop(this.element),this.hasScroll=null,this.viewport=kit.getViewportDimensions(),this.lastTimestamp=0,this.timeInterval=null},Readometer.prototype.start=function(a,b="default"){var c=Math.floor;if(!kit.isDOMElement(a))return;this.clearMemory(a);const d=kit.getProp(avgReadingSpeeds,b,"default"),e=this.element.innerText.split(" ").filter(a=>1<a.length);this.targetReadingTime=c(60*(e.length/d));const f=this.element.scrollHeight,g=this.element.clientHeight;this.hasScroll=f!==g;const h=this.viewport.height<g?this.viewport.height:g,j=this.hasScroll?0:this.distance;for(let d=1;d<=c(f/h);d++)this.milestones.push(j+h*d);return(this.hasScroll||g>this.viewport.height)&&this.milestones.push(j+f),this.absMilestones=[].concat(this.milestones),this.onScroll(),this.hasScroll?this.element.onscroll=kit.debounce(this.onScroll.bind(this),300):window.onscroll=kit.debounce(this.onScroll.bind(this),300),this.timeInterval=setInterval(()=>this.checkReadingTime(),1e3),this},Readometer.prototype.onScroll=function(){const a=this.checkReadingTime();if(!a||0===this.milestones.length)return;const b=document.documentElement.scrollTop||document.body.scrollTop||0,c=this.viewport.height<this.element.clientHeight?this.viewport.height:this.element.clientHeight,d=this.hasScroll?this.element.scrollTop+c:b+this.viewport.height;d>=this.milestones[0]&&(this.milestones.shift(),this.checkProgress())},Readometer.prototype.checkReadingTime=function(){const a=document.documentElement.scrollTop||document.body.scrollTop||0,b=this.distance-a,c=0<this.viewport.height-b,d=0<this.distance+this.element.clientHeight-a,e=!0===c&&!0===d&&!0===this.isWindowVisible,f=this.getTimestamp();return e?!1===this.reading?(this.lastTimestamp=f,this.reading=!0):!0===this.reading&&(this.readingTime+=f-this.lastTimestamp,this.lastTimestamp=f):!0===this.reading&&(this.readingTime+=f-this.lastTimestamp,this.reading=!1),this.checkProgress(),e},Readometer.prototype.checkProgress=function(){var a=Math.ceil;const b=Number.parseFloat(100*((this.absMilestones.length-this.milestones.length)/this.absMilestones.length)),c=this.targetReadingTime,d=a(100*(this.readingTime/c));let e=0;e=d>=b?b:75<=b&&75<=d?d:50<=b&&50<=d?d:0,this.progress!==e&&e>this.progress&&(this.progress=e,this.emit("progress",a(this.progress)),100===a(this.progress)&&(clearInterval(this.timeInterval),this.timeInterval=null,this.hasScroll?this.element.onscroll=null:window.onscroll=null))},Readometer.prototype.getTimestamp=function(){return Math.ceil(Date.now()/1e3)},Readometer.prototype.getElementDistanceFromTop=function(a){let b=a.offsetTop,c=a.parentElement;for(;kit.isNotEmpty(c);)b+=c.offsetTop,c=c.parentElement;return b},module.exports=Readometer;