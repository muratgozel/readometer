import t from"event-emitter-object";import e from"visibility-state-listener";import{domkit as i,typekit as s,objectkit as o,functionkit as n,validationkit as h}from"basekits";var r={default:180,ar:138,ch:158,nl:202,en:228,fi:161,fr:195,de:179,iw:187,it:188,jp:193,pl:166,pt:181,ru:184,sl:180,sp:218,sv:199,tr:166};function l(){t.call(this,{}),this.isWindowVisible=!0,this.visibilityStateListener=e(),this.visibilityStateListener.start(),this.visibilityStateListener.emitter.on("update",function(){this.isWindowVisible="visible"==this.visibilityStateListener.getState()}.bind(this))}l.prototype=Object.create(t.prototype),l.prototype.constructor=l,l.prototype.clearMemory=function(t){this.element=t,this.progress=0,this.reading=!1,this.readingTime=0,this.targetReadingTime=0,this.milestones=[],this.absMilestones=[],this.distance=this.getElementDistanceFromTop(this.element),this.hasScroll=null,this.viewport=i.getViewportDimensions(),this.lastTimestamp=0,this.timeInterval=null},l.prototype.start=function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"default";if(s.isDOMElement(t)){this.clearMemory(t);var h=o.getProp(r,i,"default"),l=this.element.innerText.split(" ").filter((function(t){return t.length>1}));this.targetReadingTime=Math.floor(l.length/h*60);var a=this.element.scrollHeight,c=this.element.clientHeight;this.hasScroll=a!==c;for(var m=this.viewport.height<c?this.viewport.height:c,p=this.hasScroll?0:this.distance,g=1;g<=Math.floor(a/m);g++)this.milestones.push(p+m*g);return(this.hasScroll||c>this.viewport.height)&&this.milestones.push(p+a),this.absMilestones=[].concat(this.milestones),this.onScroll(),this.hasScroll?this.element.onscroll=n.debounce(this.onScroll.bind(this),300):window.onscroll=n.debounce(this.onScroll.bind(this),300),this.timeInterval=setInterval((function(){return e.checkReadingTime()}),1e3),this}},l.prototype.onScroll=function(){if(this.checkReadingTime()&&0!==this.milestones.length){var t=document.documentElement.scrollTop||document.body.scrollTop||0,e=this.viewport.height<this.element.clientHeight?this.viewport.height:this.element.clientHeight;(this.hasScroll?this.element.scrollTop+e:t+this.viewport.height)>=this.milestones[0]&&(this.milestones.shift(),this.checkProgress())}},l.prototype.checkReadingTime=function(){var t=document.documentElement.scrollTop||document.body.scrollTop||0,e=this.distance-t,i=this.viewport.height-e>0,s=this.distance+this.element.clientHeight-t>0,o=!0===i&&!0===s&&!0===this.isWindowVisible,n=this.getTimestamp();return o?!1===this.reading?(this.lastTimestamp=n,this.reading=!0):!0===this.reading&&(this.readingTime+=n-this.lastTimestamp,this.lastTimestamp=n):!0===this.reading&&(this.readingTime+=n-this.lastTimestamp,this.reading=!1),this.checkProgress(),o},l.prototype.checkProgress=function(){var t=Number.parseFloat((this.absMilestones.length-this.milestones.length)/this.absMilestones.length*100),e=this.targetReadingTime,i=Math.ceil(this.readingTime/e*100),s=0;s=i>=t?t:t>=75&&i>=75||t>=50&&i>=50?i:0,this.progress!==s&&s>this.progress&&(this.progress=s,this.emit("progress",Math.ceil(this.progress)),100===Math.ceil(this.progress)&&(clearInterval(this.timeInterval),this.timeInterval=null,this.hasScroll?this.element.onscroll=null:window.onscroll=null))},l.prototype.getTimestamp=function(){return Math.ceil(Date.now()/1e3)},l.prototype.getElementDistanceFromTop=function(t){for(var e=t.offsetTop,i=t.parentElement;h.isNotEmpty(i);)e+=i.offsetTop,i=i.parentElement;return e};export default l;
